
## 1.æ€ä¹ˆçœ‹å½“å‰æ–‡æœ¬çš„åˆ†è¯ç»“æœ

```powershell
# æŒ‡å®šanalyzer
GET /yuan/_analyze
{
    "analyzer": "standard",
    "text": "eç”Ÿä¿2020ç‰ˆä¿éšœä»€ä¹ˆå†…å®¹"
}

# é€šè¿‡å‘ŠçŸ¥typenameæ˜ç¡®analyzer
GET yuan/_analyze 
{
  "field": "_doc", 
  "text":  "eç”Ÿä¿2020ç‰ˆå’Œeç”Ÿä¿2018ç‰ˆçš„åŒºåˆ«æ˜¯ä»€ä¹ˆ"
}
```

[https://www.elastic.co/guide/en/elasticsearch/reference/7.1/\_testing\_analyzers.html](https://www.elastic.co/guide/en/elasticsearch/reference/7.1/_testing_analyzers.html "https://www.elastic.co/guide/en/elasticsearch/reference/7.1/_testing_analyzers.html")

## 2.é»˜è®¤çš„åˆ†è¯å™¨ä»‹ç»

ESçš„é»˜è®¤åˆ†è¯è®¾ç½®æ˜¯standardï¼Œè¿™ä¸ªåœ¨ä¸­æ–‡åˆ†è¯æ—¶å°±æ¯”è¾ƒå°´å°¬äº†ï¼Œä¼šå•å­—æ‹†åˆ†ï¼Œæ¯”å¦‚æˆ‘æœç´¢å…³é”®è¯â€œæ¸…åå¤§å­¦â€ï¼Œè¿™æ—¶å€™ä¼šæŒ‰â€œæ¸…â€ï¼Œâ€œåâ€ï¼Œâ€œå¤§â€ï¼Œâ€œå­¦â€å»åˆ†è¯ï¼Œç„¶åæœå‡ºæ¥çš„éƒ½æ˜¯äº›â€œæ¸…æ¸…çš„æ²³æ°´â€ï¼Œâ€œä¸­åå„¿å¥³â€ï¼Œâ€œåœ°å¤§ç‰©åšâ€ï¼Œâ€œå­¦è€Œä¸æ€åˆ™ç½”â€ä¹‹ç±»çš„è«åå…¶å¦™çš„ç»“æœã€‚

standard tokenizerï¼šä»¥å•è¯è¾¹ç•Œè¿›è¡Œåˆ‡åˆ†
**standard** token filterï¼šä»€ä¹ˆéƒ½ä¸åš
**lowercase** token filterï¼šå°†æ‰€æœ‰å­—æ¯è½¬æ¢ä¸ºå°å†™
**stop** token filerï¼ˆé»˜è®¤è¢«ç¦ç”¨ï¼‰ï¼šç§»é™¤åœç”¨è¯ï¼Œæ¯”å¦‚a the itç­‰ç­‰

## 3.æ€ä¹ˆä¿®æ”¹å½“å‰é»˜è®¤çš„åˆ†è¯å™¨

-   ä¿®æ”¹é…ç½®æ–‡ä»¶

ä¾‹ï¼Œæƒ³è¦æ”¹å˜æˆé…ç½®å¥½çš„ikåˆ†è¯å™¨ï¼Œ åœ¨config/elasticsearch.ymlæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®å³å¯ï¼š

index.analysis.analyzer.default.type:ik

å‰æå½“ç„¶æ˜¯ä½ å·²ç»å®‰è£…äº†ikåˆ†è¯ã€‚

-   è¯·æ±‚

```powershell
# ä¿®æ”¹é»˜è®¤åˆ†è¯æ–¹æ³•(è¿™é‡Œä¿®æ”¹school_indexç´¢å¼•çš„é»˜è®¤åˆ†è¯ä¸ºï¼šik_max_word)ï¼š

PUT /school_index
{
    "settings" : {
        "index" : {
            "analysis.analyzer.default.type": "ik_max_word"
        }
    }
}



# å¯ç”¨englishåœç”¨è¯token filterï¼ˆå…¶ä¸­es_stdå³ä¸ºæ–°çš„åˆ†è¯å™¨ï¼‰

PUT /my_index
{
    "settings": {
        "analysis": {
            "analyzer": {
                "es_std": {
                    "type": "standard",
                    "stopwords": "english"
                }  
            }
        }
    }
}


# å®šåˆ¶åŒ–è‡ªå·±çš„åˆ†è¯å™¨
# è‡ªå®šä¹‰1ï¼šæŠŠ&æ”¹æˆand
# è‡ªå®šä¹‰2: åœç”¨è¯æŒ‡å®š the a
# è‡ªå®šä¹‰3: å»æ‰htmlæ ‡ç­¾
# customä»£è¡¨è‡ªå®šä¹‰

PUT /my_index
{
    "settings": {
        "analysis": {
            "char_filter": {
                "&_to_and":{
                    "type":"mapping",
                    "mappings":["&=>and"]
                }
            },
            "filter": {
                "my_stopwords":{
                    "type":"stop",
                    "stopwords":["the","a"] 
                }
            },
            "analyzer": {
                "my_anaylzer":{
                    "type":"custom",
                    "char_filter":["html_strip","&_to_and"],
                    "tokenizer":"standard",
                    "filter":["lowercase","my_stopwords"]
                }
            }
        }
    }
}
```

åœ¨è‡ªå·±çš„typeé‡Œè¦ç”¨åˆ°è‡ªå·±è‡ªå®šä¹‰çš„åˆ†è¯å™¨ä¸‹é¢è¯­æ³•

```powershell
PUT /my_index/_mapping/my_type
{
    "properties": {
        "content": {
            "type": "text",
            "analyzer": "my_analyzer"
        }
    }
}
```

## 4.æ€ä¹ˆå®‰è£…æ–°çš„åˆ†è¯å™¨

æ¯”å¦‚ï¼šikåˆ†è¯å™¨ï¼Œæœ‰ä¸¤ç§ik\_smartå’Œik\_max\_wordã€‚

```çº¯æ–‡æœ¬
    ik_smartä¼šå°†â€œæ¸…åå¤§å­¦â€æ•´ä¸ªåˆ†ä¸ºä¸€ä¸ªè¯ï¼Œè€Œik_max_wordä¼šå°†â€œæ¸…åå¤§å­¦â€åˆ†ä¸ºâ€œæ¸…åå¤§å­¦â€ï¼Œâ€œæ¸…åâ€å’Œâ€œå¤§å­¦â€ï¼ŒæŒ‰éœ€é€‰å…¶ä¸­ä¹‹ä¸€å°±å¯ä»¥äº†ã€‚
```

-   å®‰è£…IKåˆ†è¯å™¨

ä¸‹è½½ [github:elasticsearch-analysis-ik](https://github.com/medcl/elasticsearch-analysis-ik/releases "github:elasticsearch-analysis-ik")
é€‰æ‹©çš„**ikåˆ†è¯å™¨ç‰ˆæœ¬ä¸€å®šè¦ä¸ä½ çš„ç‰ˆæœ¬ä¸€è‡´**ï¼Œå¦åˆ™å°±æ— æ³•å¯åŠ¨esï¼Œæ¯”å¦‚æˆ‘ç”¨çš„æ˜¯6.1.4çš„esï¼Œé‚£ä¹ˆikåˆ†è¯å™¨ä¹Ÿä¸€å®šè¦6.1.4
ä¸‹è½½åˆ°elasticsearch/pluginç›®å½•ä¸‹

```bash
 wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.1.4/elasticsearch-analysis-ik-6.1.4.zip

 unzip elasticsearch-analysis-ik-6.1.4.zip
```

-   å®‰è£…ansjåˆ†è¯å™¨

[**https://github.com/NLPchina/elasticsearch-analysis-ansj/releases**](https://github.com/NLPchina/elasticsearch-analysis-ansj/releases "https://github.com/NLPchina/elasticsearch-analysis-ansj/releases") (å’Œikä¸€æ ·æ³¨æ„ç‰ˆæœ¬å·å¯¹åº”)

è§£å‹æ”¾ç½® esçš„å®‰è£…ç›®å½•pluginsä¸‹ï¼Œé‡æ–°æœåŠ¡ï¼ŒåŠ è½½åˆ†è¯å™¨è®¾ç½®

### ğŸ§¡è®¾ç½®ansjä¸ºé»˜è®¤åˆ†è¯å™¨

```çº¯æ–‡æœ¬
ä¸æ”¯æŒåŠ¨æ€è®¾ç½®ï¼Œindiceså¤„äºå¼€å¯çŠ¶æ€ï¼Œéœ€è¦å…ˆå…³é—­ï¼Œåœ¨è¿›è¡Œè®¾ç½®ï¼Œè®¾ç½®å®Œæˆååœ¨æ‰“å¼€ã€‚
é€šè¿‡APIè®¾ç½®çš„æ–¹å¼ä¸éœ€è¦é‡å¯elsatisearchã€‚çº¿ä¸Šçš„é›†ç¾¤æœ€å¥½ä¸è¦é‡å¯ï¼ŒåŠ è½½ç´¢å¼•çš„æ—¶é—´ä¼šå¾ˆä¹…å¹¶ä¸”ä¼šå¼•å‘ä¸€äº›é”™è¯¯ã€‚
```

```çº¯æ–‡æœ¬
# curl -XPOST 'localhost:9200/_all/_close'

# curl -XPUT 'http://localhost:9200/_all/_settings?preserve_existing=true' -d '{
  "index.analysis.analyzer.default.type" : "index_ansj",
  "index.analysis.analyzer.default_search.type" : "query_ansj"
}'

# curl -XPOST 'localhost:9200/_all/_open'

6.xç‰ˆæœ¬åæ‰§è¡Œputå‘½ä»¤ï¼š
6.xç‰ˆæœ¬ä»¥åä¿®æ”¹æˆ–å†™å…¥æ•°æ®åˆ°esï¼Œéƒ½è¦ä½¿ç”¨-H'Content-Type: application/json'ã€‚

#curl -XPUT -H 'Content-Type: application/json' 'http://localhost:9200/_all/_settings?preserve_existing=true' -d '{
  "index.analysis.analyzer.default.type" : "index_ansj",
  "index.analysis.analyzer.default_search.type" : "query_ansj"
}'
```

æˆ–è€…  åœ¨**elasticsearch.yml**åŠ å…¥å¦‚ä¸‹é…ç½®:

```çº¯æ–‡æœ¬
#é»˜è®¤åˆ†è¯å™¨,ç´¢å¼•
index.analysis.analyzer.default.type: index_ansj

#é»˜è®¤åˆ†è¯å™¨,æŸ¥è¯¢
index.analysis.analyzer.default_search.type: query_ansj
```

### â¤ï¸ä¸‰ç§ä¸åŒçš„ç´¢å¼•åˆ†è¯

-   index\_ansj æ˜¯ç´¢å¼•åˆ†è¯,å°½å¯èƒ½åˆ†è¯å¤„æ‰€æœ‰ç»“æœ
-   æœç´¢åˆ†è¯ (search\_ansj=to\_ansj=query\_ansj)
    ```çº¯æ–‡æœ¬
    query_ansj æ˜¯æœç´¢åˆ†è¯,æ˜¯ç´¢å¼•åˆ†è¯çš„å­é›†,ä¿è¯äº†å‡†ç¡®ç‡
    ```
-   ç”¨æˆ·è‡ªå®šä¹‰è¯å…¸ä¼˜å…ˆçš„åˆ†è¯æ–¹å¼ (user\_ansj=dic\_ansj)

### ğŸ¥°æä¾›API

```powershell
# ansj
GET /_cat/ansj/config

GET /_ansj/flush/config

GET /_ansj/flush/dic

GET /_cat/ansj?text=æˆ‘çˆ±eç”Ÿä¿2020&type=index_ansj&dic=dic&stop=stop&ambiguity=ambiguity&synonyms=synonyms&pretty=true

GET /yuan/_analyze
{
    "analyzer": "index_ansj",
    "text": "ä¸­è¯è´¹ç”¨eç”Ÿä¿2020å¯ä¸å¯ä»¥æŠ¥é”€"
}
```

### â­ï¸å¦‚ä½•ä¸é‡å¯esï¼Œä½¿å¾—å­—å…¸ç”Ÿæ•ˆ

```powershell
å…ˆæ‰§è¡Œ GET /_ansj/flush/config

åæ‰§è¡Œ GET /_ansj/flush/dic

# æ–°å»ºindexçš„æ—¶å€™æ–°çš„è¯å…¸å°±ç”Ÿæ•ˆäº†

# ä¹‹å‰å»ºçš„indexæ–°å¢æ•°æ®æ—¶ä¼šæŒ‰æ–°çš„è¯å…¸è¿›è¡Œæ“ä½œï¼Œå¦‚éœ€æŠŠä¹‹å‰çš„æ•°æ®ä¹Ÿæ›´æ–°ï¼Œåˆ™éœ€è¦reindexï¼Œé‡æ–°analyse
```

[https://www.elastic.co/cn/blog/dictionary-update-behavior-for-elasticsearch-cjk-language-analyzers](https://www.elastic.co/cn/blog/dictionary-update-behavior-for-elasticsearch-cjk-language-analyzers "https://www.elastic.co/cn/blog/dictionary-update-behavior-for-elasticsearch-cjk-language-analyzers")

## 5.åŠ è½½è‡ªå·±å®šä¹‰çš„åˆ†è¯æ¨¡å‹æ–‡ä»¶

æ¯”å¦‚åŠ è½½pyltpçš„åˆ†è¯æ¨¡å‹æ–‡ä»¶

## 6.åŠ è‡ªå®šä¹‰è¯å…¸

## 7.å¦‚ä½•è·å–analysisä¸‹æ‰€æœ‰æ”¯æŒçš„å†…å®¹

Level1: analysis

Level2:analyzer + char\_filter + filter + tokenizer

å…·ä½“çš„åªèƒ½é€šè¿‡æ–‡æ¡£ä¸€å±‚å±‚çš„æ‰¾

## 8.å»ºåº“æ’æ•°æ®ä¹‹åå†ä¿®æ”¹åˆ†è¯å™¨ï¼Œæ€ä¹ˆæ›´æ–°åº“

ç”¨æ–°çš„åˆ†è¯å™¨mappingä¸€ä¸ªæ–°çš„indexå‡ºæ¥

ç„¶åç”¨reindexè¯·æ±‚æŠŠæ—§indexæ•°æ®å¯¼å…¥åˆ°æ–°çš„æ¥
